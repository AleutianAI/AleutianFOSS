# GR-01: Graph Index Tests (Python Language)
#
# Verifies that graph index optimization works correctly for Python code.
# Tests graph tool execution, performance, and edge cases.

metadata:
  feature: GR-01
  title: "Graph Index Optimization"
  language: python
  project: flask
  ticket: tickets/merged/GR-01_graph_index.md
  description: >
    Tests CRS graph index functionality on Python code. Verifies that
    find_callers, find_callees, and find_implementations use the graph
    index efficiently for Python modules, classes, and functions.

tests:
  - id: 116
    name: py_find_callers_basic
    category: GRAPH_INDEX
    description: >
      Verify find_callers returns results correctly for Python code.
      This query should trigger the graph index and find all callers
      of Flask's create_app factory function.
    query: |
      Find all callers of the create_app function
    expected_state: COMPLETE
    validations:
      - type: graph_tool_used

  - id: 117
    name: py_find_callees_basic
    category: GRAPH_INDEX
    description: >
      Verify find_callees returns results correctly for Python code.
      This query should use the graph index to find all functions
      called within the Flask app initialization.
    query: |
      Find all functions called by the Flask() constructor
    expected_state: COMPLETE
    validations:
      - type: graph_tool_used

  - id: 118
    name: py_find_impls_basic
    category: GRAPH_INDEX
    description: >
      Verify find_implementations returns results correctly for Python.
      This query should use the graph index to find implementations
      of Python classes/protocols.
    query: |
      Find all implementations of the Blueprint class
    expected_state: COMPLETE
    validations:
      - type: graph_tool_used

  - id: 119
    name: py_perf_warm
    category: GRAPH_INDEX
    description: >
      Performance test - second query should be fast (index warmed).
      After initial index build for Python modules, subsequent queries
      should benefit from the cached graph index.
    query: |
      Find callers of register_blueprint in this codebase
    expected_state: COMPLETE
    validations:
      - type: fast_execution

  - id: 120
    name: py_otel_trace
    category: GRAPH_INDEX
    description: >
      Verify OTel spans capture index usage for Python code.
      This internal test checks that CRS events contain index_used=true
      attribute in OpenTelemetry spans.
    query: INTERNAL:verify_index_span_attribute
    expected_state: COMPLETE
    validations: []

  - id: 121
    name: py_not_found_fast
    category: GRAPH_INDEX
    description: >
      Edge case - symbol not found should return quickly (O(1) fail fast).
      When a Python symbol doesn't exist, the index should detect this
      quickly without scanning all modules.
    query: |
      Find callers of nonexistent_python_function_xyz123
    expected_state: COMPLETE
    validations:
      - type: fast_not_found
