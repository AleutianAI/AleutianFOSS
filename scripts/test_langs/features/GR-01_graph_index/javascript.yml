# GR-01: Graph Index Tests (JavaScript Language)
#
# Verifies that graph index optimization works correctly for JavaScript code.
# Tests graph tool execution, performance, and edge cases.

metadata:
  feature: GR-01
  title: "Graph Index Optimization"
  language: javascript
  project: express
  ticket: tickets/merged/GR-01_graph_index.md
  description: >
    Tests CRS graph index functionality on JavaScript code. Verifies that
    find_callers, find_callees, and find_implementations use the graph
    index efficiently for JavaScript modules, CommonJS exports, and functions.

tests:
  - id: 216
    name: js_find_callers_basic
    category: GRAPH_INDEX
    description: >
      Verify find_callers returns results correctly for JavaScript code.
      This query should trigger the graph index and find all callers
      of Express's Router() factory function.
    query: |
      Find all callers of the Router function
    expected_state: COMPLETE
    validations:
      - type: graph_tool_used

  - id: 217
    name: js_find_callees_basic
    category: GRAPH_INDEX
    description: >
      Verify find_callees returns results correctly for JavaScript code.
      This query should use the graph index to find all functions
      called during Express app setup.
    query: |
      Find all functions called by the express() application factory
    expected_state: COMPLETE
    validations:
      - type: graph_tool_used

  - id: 218
    name: js_find_impls_basic
    category: GRAPH_INDEX
    description: >
      Verify find_implementations returns results correctly for JavaScript.
      This query should use the graph index to find implementations
      of JavaScript classes/prototypes.
    query: |
      Find all implementations of the middleware pattern
    expected_state: COMPLETE
    validations:
      - type: graph_tool_used

  - id: 219
    name: js_perf_warm
    category: GRAPH_INDEX
    description: >
      Performance test - second query should be fast (index warmed).
      After initial index build for JavaScript modules, subsequent queries
      should benefit from the cached graph index.
    query: |
      Find callers of app.use in this codebase
    expected_state: COMPLETE
    validations:
      - type: fast_execution

  - id: 220
    name: js_otel_trace
    category: GRAPH_INDEX
    description: >
      Verify OTel spans capture index usage for JavaScript code.
      This internal test checks that CRS events contain index_used=true
      attribute in OpenTelemetry spans.
    query: INTERNAL:verify_index_span_attribute
    expected_state: COMPLETE
    validations: []

  - id: 221
    name: js_not_found_fast
    category: GRAPH_INDEX
    description: >
      Edge case - symbol not found should return quickly (O(1) fail fast).
      When a JavaScript symbol doesn't exist, the index should detect this
      quickly without scanning all modules.
    query: |
      Find callers of nonExistentJavaScriptFunctionXYZ123
    expected_state: COMPLETE
    validations:
      - type: fast_not_found
